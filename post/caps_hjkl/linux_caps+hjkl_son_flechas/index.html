<!DOCTYPE html>
<html lang="en"><head>
    <title>Página principal</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://fabrice-bernes.github.io/img/favicon.svg" type="image/png" />
    <link rel="canonical" href="https://fabrice-bernes.github.io/">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://fabrice-bernes.github.io/">Página principal</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>Sobre el sitio</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/post/">
                                    
                                    <span>Notas</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>BloqMayús es una tecla poderosa - Tue, May 2, 2023</h1>
    </div>
    <p class="lead">Cómo usar BloqMayús como modificador de otras teclas</p>
    <h1 id="después-de-usar-vim-usar-hjkl-como-direcciones-es-muy-cómodo">Después de usar VIM, usar hjkl como direcciones es muy cómodo</h1>
<p>La wiki de Arch explica cómo hacer que todos los teclados hagan que
BloqMayús+hjkl se reconozca como las flechas de dirección en cualquier sesión de X11,
pero es una explicación algo escueta y no quiero leer todo lo anterior y más para llegar a eso.</p>
<p>Esta guía la escribo sin entender los conceptos tan abstractos que usa X11 para enviar eventos de teclado
(scancodes, keycodes, layers, modifiers, symbols &hellip;)</p>
<p>Primero que nada, conviene quitar <strong>cualquier</strong> modificación previa a BloqMayús.
Esto incluye keybinds puestos en awesome, y opciones como <code>option caps:none</code> de <code>setxkbmap</code>.</p>
<ul>
<li>Si algún atajo de awesome intercepta la tecla BloqMayús, entonces
<code>xev</code> mostrará eventos de BloqMayús como líneas llenas de ceros. Algo similar a esto:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>KeymapNotify event, serial 36, synthetic NO, window 0x0,
</span></span><span style="display:flex;"><span>    keys:  <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">32</span>  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><ul>
<li>Y si hemos configurado <code>setxkbmap</code> para cambiar el comportamiento de BloqMayús,
tenemos que ir a <code>/etc/X11/xorg.conf.d/00-keyboard.conf</code>
y quitar lo que esté en la línea que dice <code>Option &quot;XkbOptions&quot;</code>.
Por ejemplo, en vez de:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Section <span style="color:#e6db74">&#34;InputClass&#34;</span>
</span></span><span style="display:flex;"><span>        Identifier <span style="color:#e6db74">&#34;system-keyboard&#34;</span>
</span></span><span style="display:flex;"><span>        MatchIsKeyboard <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>        Option <span style="color:#e6db74">&#34;XkbLayout&#34;</span> <span style="color:#e6db74">&#34;latam&#34;</span>
</span></span><span style="display:flex;"><span>        Option <span style="color:#e6db74">&#34;XkbOptions&#34;</span> <span style="color:#e6db74">&#34;keypad:pointerkeys,caps:none&#34;</span>
</span></span><span style="display:flex;"><span>EndSection
</span></span></code></pre></div><p>Queremos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Section <span style="color:#e6db74">&#34;InputClass&#34;</span>
</span></span><span style="display:flex;"><span>        Identifier <span style="color:#e6db74">&#34;system-keyboard&#34;</span>
</span></span><span style="display:flex;"><span>        MatchIsKeyboard <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>        Option <span style="color:#e6db74">&#34;XkbLayout&#34;</span> <span style="color:#e6db74">&#34;latam&#34;</span>
</span></span><span style="display:flex;"><span>        Option <span style="color:#e6db74">&#34;XkbOptions&#34;</span> <span style="color:#e6db74">&#34;keypad:pointerkeys&#34;</span>
</span></span><span style="display:flex;"><span>EndSection
</span></span></code></pre></div><p>Pongo todo el archivo en vez de sólo la línea importante para recordar cómo se ve <code>XkbOptions</code>
en un archivo de configuración. Las opciones van separadas por comas <strong>sin espacios</strong>,
y tienen la forma <code>objeto:propiedad</code>.</p>
<p>Ya que quitamos a <code>xkbmap</code> y <code>awesome</code> de enmedio, podemos cambiar archivos más profundos.
Primero que nada, hagamos a <code>/usr/share/X11/xkb</code> nuestro directorio de trabajo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /usr/share/X11/xkb
</span></span></code></pre></div><h2 id="archivo-types">Archivo types</h2>
<p>Abrimos <code>types/complete</code> con un editor de texto.
Originalmente se veía así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default xkb_types <span style="color:#e6db74">&#34;complete&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;basic&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;mousekeys&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;pc&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;iso9995&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;level5&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;extra&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;numpad&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Ahora se ve así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default xkb_types <span style="color:#e6db74">&#34;complete&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;basic&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;mousekeys&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;pc&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;iso9995&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;level5&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;extra&#34;</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;numpad&#34;</span>
</span></span><span style="display:flex;"><span>    type <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    modifiers<span style="color:#f92672">=</span> Shift+Lock;
</span></span><span style="display:flex;"><span>    map<span style="color:#f92672">[</span>Shift<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> Level2;            //maps shift and no Lock. Shift+Alt goes here, too, because Alt isn<span style="color:#960050;background-color:#1e0010">&#39;</span>t in modifiers.
</span></span><span style="display:flex;"><span>    map<span style="color:#f92672">[</span>Lock<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> Level3;
</span></span><span style="display:flex;"><span>    map<span style="color:#f92672">[</span>Shift+Lock<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> Level3;       //maps shift and Lock. Shift+Lock+Alt goes here, too.
</span></span><span style="display:flex;"><span>    level_name<span style="color:#f92672">[</span>Level1<span style="color:#f92672">]=</span> <span style="color:#e6db74">&#34;Base&#34;</span>;
</span></span><span style="display:flex;"><span>    level_name<span style="color:#f92672">[</span>Level2<span style="color:#f92672">]=</span> <span style="color:#e6db74">&#34;Shift&#34;</span>;
</span></span><span style="display:flex;"><span>    level_name<span style="color:#f92672">[</span>Level3<span style="color:#f92672">]=</span> <span style="color:#e6db74">&#34;Lock&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Podemos poner comentarios empezando con <code>//</code>,
y en este archivo estamos usando 4 espacios para indentar,
aunque dudo que importe. Incluso líneas en blanco deberían dejar todo bien
siempre y cuando los delimitadores (; {}; []) estén bien.</p>
<h2 id="archivo-compatibility">Archivo compatibility</h2>
<p>Abrimos <code>compat/complete</code> con un editor de texto.
Originalmente se veía así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default xkb_compatibility <span style="color:#e6db74">&#34;complete&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;basic&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;iso9995&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;mousekeys&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;accessx(full)&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;misc&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;xfree86&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;level5&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;caps(caps_lock)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Ahora se ve así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default xkb_compatibility <span style="color:#e6db74">&#34;complete&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    include <span style="color:#e6db74">&#34;basic&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;iso9995&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;mousekeys&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;accessx(full)&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;misc&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;xfree86&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;level5&#34;</span>
</span></span><span style="display:flex;"><span>    augment <span style="color:#e6db74">&#34;caps(caps_lock)&#34;</span>
</span></span><span style="display:flex;"><span>    interpret Caps_Lock+AnyOfOrNone<span style="color:#f92672">(</span>all<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    action<span style="color:#f92672">=</span> SetMods<span style="color:#f92672">(</span>modifiers<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><h2 id="archivo-symbols">Archivo symbols</h2>
<p>Esta parte es la más complicada.
Aunque podríamos pensar que debemos modificar <code>symbols/latam</code>,
en realidad debemos cambiar <code>symbols/pc</code>.
De todas formas <code>symbols/latam</code> tiene mapeos que se aplicarán <em>después</em> de incluir <code>symbols/pc</code>.
Resulta que <code>pc</code> aplica a todas las distribuciones de teclado.
Entonces, abrimos <code>symbols/pc</code> con un editor de texto.</p>
<p>Vamos a escribir varias entradas en el bloque <code>xkb_symbols &quot;pc105&quot;</code>.</p>
<p>Aquí pondré las primeras 10 líneas de ese archivo, y la última después de los puntos suspensivos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>// The keys that are common to all standard layouts.
</span></span><span style="display:flex;"><span>default partial alphanumeric_keys modifier_keys
</span></span><span style="display:flex;"><span>xkb_symbols <span style="color:#e6db74">&#34;pc105&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    key  &lt;ESC&gt; <span style="color:#f92672">{[</span>  Escape  <span style="color:#f92672">]}</span>;
</span></span><span style="display:flex;"><span>    key  &lt;TAB&gt; <span style="color:#f92672">{[</span>  Tab,  ISO_Left_Tab  <span style="color:#f92672">]}</span>;
</span></span><span style="display:flex;"><span>    key &lt;CAPS&gt; <span style="color:#f92672">{[</span>  Caps_Lock  <span style="color:#f92672">]}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    key &lt;BKSP&gt; <span style="color:#f92672">{[</span>  BackSpace,  BackSpace  <span style="color:#f92672">]}</span>;
</span></span><span style="display:flex;"><span>    key &lt;BKSL&gt; <span style="color:#f92672">{[</span>  backslash,  bar  <span style="color:#f92672">]}</span>;
</span></span><span style="display:flex;"><span>    ... // &lt;-----Esos puntos suspensivos no son parte del archivo <span style="color:#f92672">(</span>-:
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Las entradas que vamos a poner pueden ir donde sea.
Yo las puse entre la que dice <code>&lt;CAPS&gt;</code> y la que dice <code>&lt;BKSP&gt;</code>.
Necesitamos una para cada dirección (arriba, abajo, izquierda, derecha).</p>
<p>La forma de las entradas es:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    key &lt;$1&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    |  type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>    |  symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               $2,               $3,               $4<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    |  actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;$5&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Donde dejé marcados los espacios que hay que llenar con <code>$número</code>.
Ahora pongo una guía de cómo encontrar cada uno de esos espacios:</p>
<h3 id="primer-elemento">Primer elemento</h3>
<p><code>$1</code> es el código que se encuentra en el archivo <code>keycodes/xfree86</code>.
En ese archivo encontraremos líneas como:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    &lt;CAPS&gt; <span style="color:#f92672">=</span>  66;
</span></span><span style="display:flex;"><span>    &lt;AC01&gt; <span style="color:#f92672">=</span>  38;
</span></span><span style="display:flex;"><span>    &lt;AC02&gt; <span style="color:#f92672">=</span>  39;
</span></span><span style="display:flex;"><span>    &lt;AC03&gt; <span style="color:#f92672">=</span>  40;
</span></span></code></pre></div><p>Lo que haremos será ejecutar <code>xev</code> y presionar la tecla que queremos reasignar.
Por ejemplo, queremos que la <code>h</code> sea la flecha a la izquierda.
Si presionamos la <code>h</code> cuando la ventana de <code>xev</code> está enfocada,
la terminal muestra esto sobre el evento <code>KeyRelease</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>KeyRelease event, serial 36, synthetic NO, window 0x4400001,
</span></span><span style="display:flex;"><span>    root 0x1e1, subw 0x0, time 162032730, <span style="color:#f92672">(</span>889,773<span style="color:#f92672">)</span>, root:<span style="color:#f92672">(</span>891,793<span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>    state 0x10, keycode <span style="color:#ae81ff">43</span> <span style="color:#f92672">(</span>keysym 0x68, h<span style="color:#f92672">)</span>, same_screen YES,
</span></span><span style="display:flex;"><span>    XLookupString gives <span style="color:#ae81ff">1</span> bytes: <span style="color:#f92672">(</span>68<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;h&#34;</span>
</span></span><span style="display:flex;"><span>    XFilterEvent returns: False
</span></span></code></pre></div><p>Lo importante aquí es la línea con <code>keycode 43</code>. De hecho, si lo anterior es confuso,
podíamos haber corrido <code>xev</code> detrás de un pipe hacia <code>grep</code> así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xev | grep keycode
</span></span></code></pre></div><p>para tener una salida más legible (TODO: <code>awk</code> debería ser aún más limpio. O se necesitan 2 pipes?).</p>
<p>Como sea, ahora buscaremos la línea que asigna un label al keycode 43 en <code>keycodes/xfree86</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;AC06&gt; <span style="color:#f92672">=</span>  43;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Entonces lo que debe ir en la marca <code>$1</code> es <code>AC06</code> para el mapeo de la h.</p>
<h3 id="segundo-tercero-y-cuarto-elemento">Segundo, tercero y cuarto elemento</h3>
<p>No me he dedicado a leer sobre el verdadero significado de cada entrada.
Creo que está explicado en la wiki de arch,
pero de todas formas, para estos mapeos sólo puse
la tecla minúscula, mayúscula, y su nombre en inglés (no es ni un label ni un keycode. No sé qué sea.).</p>
<p>Así, por ejemplo, para remapear la h, las entradas <code>$2</code>, <code>$3</code> y <code>$4</code> dicen:</p>
<ul>
<li>h</li>
<li>H</li>
<li>Left</li>
</ul>
<p>Sin comillas ni nada. Al final de esta guía pongo las entradas completas para los 4 remapeos.</p>
<h3 id="quinto-elemento">Quinto elemento</h3>
<p>Aquí pondemos el label de la tecla que nos gustaría que X11 envíe cuando presionamos BloqMayús + hjkl.</p>
<p>Por alguna razón (más bien porque no leí la wiki) <code>xev</code> indica que
los keycodes de las flechas están mapeados a teclas que
en <code>keycodes/xfree86</code> tienen etiquetas inesperadas como <code>&lt;RALT&gt;</code>.</p>
<p>Pero lo correcto es poner etiquetas <code>&lt;UP&gt;</code> <code>&lt;DOWN&gt;</code> <code>&lt;LEFT&gt;</code> y <code>&lt;RGHT&gt;</code> (no me comí la I en RGHT).
Esas etiquetas aparecen así en mi <code>keycodes/xfree86</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    &lt;UP&gt;     <span style="color:#f92672">=</span>  98;
</span></span><span style="display:flex;"><span>    &lt;LEFT&gt;   <span style="color:#f92672">=</span>  100;
</span></span><span style="display:flex;"><span>    &lt;DOWN&gt;   <span style="color:#f92672">=</span>  104;
</span></span><span style="display:flex;"><span>    &lt;RGHT&gt;   <span style="color:#f92672">=</span>  102;
</span></span></code></pre></div><p>Y no tengo idea de qué teclas físicas envían esos códigos.
Pero para el quinto elemento sólo nos interesan las etiquetas,
las cuales tengo entendido que son de por sí arbitrarias (como aliases).</p>
<p>Entonces, para el remapeo de la h, el quinto elemento es <code>LEFT</code>.</p>
<h2 id="las-entradas-que-yo-hice">Las entradas que yo hice</h2>
<p>Mis entradas quedaron así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    key &lt;AC06&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    |  type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>    |  symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               h,               H,               Left<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    |  actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;LEFT&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC09&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    |  type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>    |  symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               l,               L,               Right<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    |  actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;RGHT&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC08&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    |  type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>    |  symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               k,               K,               Up<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    |  actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;UP&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC07&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    |  type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>    |  symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               j,               j,               Down<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    |  actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;DOWN&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Ahora, para probar los cambios, podemos cerrar nuestra sesión y volver a entrar,
o simplemente abrir una terminal y poner <code>setxkbmap latam</code>.</p>
<p>Si hicimos algo mal, la terminal dirá algo como que hubo un error al cargar el keymap.
Si hicimos algo MUY mal, podría cargarse un fallback, o podríamos tener un teclado chistoso.
Como sólo estamos remapeando al nivel de X11, podemos arreglar nuestros errores desde una tty.</p>
<p>Aunque este método puede parecer extremo
(creo que es posible hacer archivos con symbols, types y compat <em>por usuario</em>),
es realmente muy robusto.
Ningún programa que esté a la espera de que presionemos las flechas sabrá que
físicamente estamos usando otras teclas. Ni siquiera nuestro gestor de ventanas.</p>
<p>Además, la tecla BloqMayús sigue identificándose como tal cuando no la presiona junto a <code>hjkl</code>.
Por lo que ya podemos regresar a nuestros keybinds de awesome y
asignar acciones a la tecla con scancode <code>&quot;Caps_Lock&quot;</code> sin problemas.</p>
<p>Aún no he intentado usar uno de los modificadores de <code>XkbOptions</code> como <code>caps:none</code>
(en cuyo caso los keybinds de awesome se pueden asignar a <code>&quot;VoydSymbol&quot;</code> si no me equivoco),
pero todo apunta a que la tecla como tal ha quedado intacta,
salvo que ya no es un <em>toggle switch</em> sino un <em>momentary switch</em>,
y si actúa detrás de otras teclas, entonces es un modificador que no cambia de capa,
sino que traduce la tecla modificada a los <code>keycodes</code> que querramos.</p>
<p>Deberíamos poder usar <code>XkbOptions</code> para que caps se identifique como la tecla Escape por ejemplo.
Luego, awesome puede usar keybinds como Super+Escape,
y vim puede usar BloqMayús para ir al modo normal.
De todas formas por ahora me contento con no tener <code>XkbOptions</code> aparte de mousekeys.</p>
<h2 id="vale-la-pena-hacerlo-así">Vale la pena hacerlo así?</h2>
<p>Como todo en Linux, esta es una de muchas formas de lograr lo mismo.</p>
<p>Cada una con sus ventajas y desventajas.
<a href="https://tbuss.de/posts/2021/5-capslock_as_vim_modifier/">Este man</a>
logra lo mismo pero usando <code>xbindkeys</code>.
Y en muchos lugar se mencionan xbindkeys y xmodmap para cosas similares,
principalmente porque son mucho más fáciles de configurar.</p>
<p>Sobre <code>xmodmap</code>, la wiki de arch dice:</p>
<p><em>&ldquo;xmodmap is not directly related to X keyboard extension (XKB),
as it uses different (pre-XKB) ideas on how keycodes are processed within X.
Generally, it is only recommended for the simplest tasks.&rdquo;</em></p>
<p>Y eso no me agrada.
<code>xbindkeys</code> parece bastante mejor, y admite tanto mapeos directos y sencillos
(como los del artículo del man)
como scripts complejos con <em>guile</em>, un lenguaje basado en lisp.</p>
<p>De hecho, usé durante mucho tiempo el script que se muestra
<a href="http://computers-stuff.blogspot.com/2007/06/my-xbindkeysrcscm-configruationf-file-i.html">aquí</a>
y siempre me funcionó perfecto. Se comporta así:</p>
<p>Mi ratón tiene 5 botones.</p>
<ul>
<li>Si hago scroll mientras presiono uno de los laterales, el volumen del sistema cambia.</li>
<li>Si hago scroll mientras presiono el otro lateral, el volumen del reproductor cambia.</li>
<li>Presionar un lateral más la ruedita del ratón, permite mutear el audio del sistema.</li>
<li>Presionar el otro lateral más la ruedita del ratón, permite mutear el reproductor.</li>
<li>Presionar los laterales solitos los hace funcionar como por defecto (Prev/Next).</li>
</ul>
<p>Así que <code>xbindkeys</code> es muy versátil cuando se lo usa con todo lo que ofrece,
pero también es de más alto nivel que lo que hicimos en esta guía,
y aunque me funcionó perfectamente para el ratón, no me ha ido tan bien con el teclado.</p>
<p>Eso es contenido para otra guía, pero he visto que un desarrollador de <code>awesome</code>
<a href="https://github.com/awesomeWM/awesome/issues/1494">no recomienda usar xbindkeys</a>.
Dice así:</p>
<p><em>&ldquo;Do not use obsolete tools like xmodmap. I have yet to see setxkbmap also causing this.
(And yes, I know that xmodmap is so much easier to use than setxkbmap).&rdquo;</em></p>
<h2 id="una-nota-muy-importante">Una nota muy importante</h2>
<p>En un inicio de sesión posterior, y todos los que le siguieron, me di cuenta de que
las teclas hjkl <em>ya no se auto-repetían cuando las mantenía presionadas</em>,
y eso se siente como usar calcetas llenas de lodo.</p>
<p>Aún así, me ayudó a quitarme unas malas costumbre que tenía con vim,
pero es un problema enorme de todas formas.</p>
<p>Para corregirlo, fui a ver
<a href="https://unix.stackexchange.com/questions/41724/how-to-make-custom-key-type-auto-repeat-in-xkb">aquí</a>,
y le agregué líneas <code>autorepeat = yes</code> a cada entrada de <code>symbols/pc</code>,
para que todo se vea así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    key &lt;AC06&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       autorepeat<span style="color:#f92672">=</span> yes,
</span></span><span style="display:flex;"><span>       type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>       symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               h,               H,               Left<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>       actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;LEFT&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC07&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       autorepeat<span style="color:#f92672">=</span> yes,
</span></span><span style="display:flex;"><span>       type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>       symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               j,               j,               Down<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>       actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;DOWN&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC08&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       autorepeat<span style="color:#f92672">=</span> yes,
</span></span><span style="display:flex;"><span>       type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>       symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               k,               K,               Up<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>       actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;UP&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    key &lt;AC09&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       autorepeat<span style="color:#f92672">=</span> yes,
</span></span><span style="display:flex;"><span>       type<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUST_CAPSLOCK&#34;</span>,
</span></span><span style="display:flex;"><span>       symbols<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>               l,               L,               Right<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>       actions<span style="color:#f92672">[</span>Group1<span style="color:#f92672">]=</span> <span style="color:#f92672">[</span>      NoAction<span style="color:#f92672">()</span>,      NoAction<span style="color:#f92672">()</span>,   RedirectKey<span style="color:#f92672">(</span>keycode<span style="color:#f92672">=</span>&lt;RGHT&gt;, clearmods<span style="color:#f92672">=</span>Lock<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>Pero eso no arregló nada y no sé si culpar a <code>X11</code>
o a lo poco que entiendo de cómo se mapea un teclado.</p>
<p>Lo que arregló el problema fue (aún así decidí quedarme con las líneas <code>autorepeat= yes</code>)
fue correr <code>xset r &lt;keycode&gt;</code> para cada letra.</p>
<p>Así, por ejemplo, viendo que escribí <code>key &lt;AC09&gt;</code> en <code>symbols/pc</code>,
si busco eso en <code>keycodes/xfree86</code>, veo que dice <code>&lt;AC09&gt; =  46;</code>
y entonces corro <code>xset r 46</code>.</p>
<p>Al final, lo que hice fue correr lo siguiente al iniciar sesión:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xset r <span style="color:#ae81ff">43</span>
</span></span><span style="display:flex;"><span>xset r <span style="color:#ae81ff">46</span>
</span></span><span style="display:flex;"><span>xset r <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span>xset r <span style="color:#ae81ff">44</span>
</span></span></code></pre></div><p>Eso lo puse en mi <code>.xinitrc</code> cuando no usaba un display manager.
Ahora que uso <code>lighdm</code> con <code>minigreeter</code>, lo pongo en <code>.xprofile</code>.</p>
<p>Ya buscaré una forma más limpia e igual de robusta para remapear teclas
sin interferir con el autorepeat.</p>
<h2 id="extra-typematic-delay-and-typematic-rate">Extra: typematic delay and typematic rate</h2>
<p>Si corro <code>xset r rate</code>, el teclado esperará a que mantenga una tecla presionada por 660ms
antes de empezar a auto repetirla a 25Hz.</p>
<p>Si quiero que empiece a repetirla a 30Hz luego de 330ms, corro <code>xset r rate 330 30</code>.</p>
<h2 id="otros-enlaces-de-interés">Otros enlaces de interés</h2>
<p><a href="https://unix.stackexchange.com/questions/188164/override-a-few-keycodes-with-xkb">https://unix.stackexchange.com/questions/188164/override-a-few-keycodes-with-xkb</a></p>
<p><a href="https://github.com/jbriales/xkb-extended-keys">https://github.com/jbriales/xkb-extended-keys</a></p>

    <h4><a href="https://fabrice-bernes.github.io/">Volver a la página principal</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
&copy; 

    Fabrice Bernès Carmona

<span id="thisyear">2023</span>


</p>
    <p class="text-center">
        <a href="https://github.com/Fabrice-Bernes">GitHub</a> 
        
        <a href="mailto:Fabrice.Bernes@protonmail.com">email</a> 
        
        
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: true ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script>
</html>
